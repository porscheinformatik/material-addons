@use 'sass:map';
@use '@angular/material' as mat;
@use './theme';

@import 'material-icons/iconfont/material-icons.css';
@import 'roboto-fontface/css/roboto/roboto-fontface.css';

@include mat.elevation-classes();
@include mat.app-background();

//TODO Contrasts should be part of the themes!
$contrast: (
  50: rgba(black, 0.87),
  100: rgba(black, 0.87),
  200: rgba(black, 0.87),
  300: rgba(black, 0.87),
  400: rgba(black, 0.87),
  500: white,
  600: white,
  700: white,
  800: white,
  900: white,
  A100: rgba(black, 0.87),
  A200: rgba(black, 0.87),
  A400: rgba(black, 0.87),
  A700: rgba(black, 0.87),
);

$default-palette: (
  panel-background-color: #e8e8e8,
  panel-border-color: #cccccc,
  panel-select-background: white,
  alert-success-background-color: rgb(238, 252, 227),
  alert-success-border-color: rgb(66, 129, 14),
  alert-success-text-color: #155724,
  alert-info-background-color: rgb(229, 247, 255),
  alert-info-border-color: rgb(0, 121, 173),
  alert-info-text-color: #0c5460,
  alert-warning-background-color: rgb(255, 242, 214),
  alert-warning-border-color: rgb(255, 185, 46),
  alert-warning-text-color: #856404,
  alert-error-background-color: rgb(255, 242, 240),
  alert-error-border-color: rgb(224, 34, 0),
  alert-error-text-color: #721c24,
);

// Mixin to define CSS variables (must be called in :root selector)
@mixin color-variables($theme-name, $theme) {
  // Extract M3 theme values using utility functions
  $main-primary: theme.get-main-color();
  $selection-background: theme.get-selection-background();
  $table-hover-color: theme.get-table-hover-color($main-primary);
  $background-color: theme.get-background-color();
  $hover-color: theme.get-hover-color();
  $panel-color: theme.get-panel-color();

  // Get custom semantic colors from M3 custom colors map
  $warn-color: theme.get-custom-color(warn-color);
  $error-color: theme.get-custom-color(error-color);
  $info-color: theme.get-custom-color(info-color);
  $success-color: theme.get-custom-color(success-color);

  // Panel colors from defaults
  $panel-background-color: theme.map-get-or-default(theme.$m3-custom-colors, panel-background-color);
  $panel-border-color: theme.map-get-or-default(theme.$m3-custom-colors, panel-border-color);
  $panel-select-background: theme.map-get-or-default(theme.$m3-custom-colors, panel-select-background);

  // Alert colors from defaults
  $alert-success-background-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-success-background-color);
  $alert-success-border-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-success-border-color);
  $alert-success-text-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-success-text-color);

  $alert-info-background-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-info-background-color);
  $alert-info-border-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-info-border-color);
  $alert-info-text-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-info-text-color);

  $alert-warning-background-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-warning-background-color);
  $alert-warning-border-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-warning-border-color);
  $alert-warning-text-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-warning-text-color);

  $alert-error-background-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-error-background-color);
  $alert-error-border-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-error-border-color);
  $alert-error-text-color: theme.map-get-or-default(theme.$m3-custom-colors, alert-error-text-color);

  // M3 system colors (for future use)
  $mat-sys-primary: $main-primary;
  $mat-sys-surface: #ffffff;
  $mat-sys-surface-variant: #f5f5f5;
  $mat-sys-on-surface: rgba(0, 0, 0, 0.87);
  $mat-sys-on-surface-variant: rgba(0, 0, 0, 0.6);
  $mat-sys-outline: rgba(0, 0, 0, 0.4);
  $mat-sys-outline-variant: #dcdcdc;

  // Existing CSS variables (preserved for backward compatibility)
  --main-primary: #{$main-primary};
  --selection-background: #{$selection-background};
  --hover-color: #{$hover-color};
  --table-hover-color: #{$table-hover-color};
  --warn-color: #{$warn-color};
  --error-color: #{$error-color};
  --background-color: #{$background-color};
  --panel-color: #{$panel-color};
  --panel-background-color: #{$panel-background-color};
  --panel-border-color: #{$panel-border-color};
  --panel-select-background: #{$panel-select-background};
  --mat-button-protected-label-text-color: #{$main-primary};
  --alert-success-background-color: #{$alert-success-background-color};
  --alert-success-border-color: #{$alert-success-border-color};
  --alert-success-text-color: #{$alert-success-text-color};
  --alert-info-background-color: #{$alert-info-background-color};
  --alert-info-border-color: #{$alert-info-border-color};
  --alert-info-text-color: #{$alert-info-text-color};
  --alert-warning-background-color: #{$alert-warning-background-color};
  --alert-warning-border-color: #{$alert-warning-border-color};
  --alert-warning-text-color: #{$alert-warning-text-color};
  --alert-error-background-color: #{$alert-error-background-color};
  --alert-error-border-color: #{$alert-error-border-color};
  --alert-error-text-color: #{$alert-error-text-color};

  // M3 system tokens (new)
  --mat-sys-primary: #{$mat-sys-primary};
  --mat-sys-surface: #{$mat-sys-surface};
  --mat-sys-surface-variant: #{$mat-sys-surface-variant};
  --mat-sys-on-surface: #{$mat-sys-on-surface};
  --mat-sys-on-surface-variant: #{$mat-sys-on-surface-variant};
  --mat-sys-outline: #{$mat-sys-outline};
  --mat-sys-outline-variant: #{$mat-sys-outline-variant};

  // Component-specific tokens (new)
  --step-border-color: #{$mat-sys-outline-variant};
  --step-complete-color: #{$alert-success-border-color};
  --step-neutral-color: #{$mat-sys-outline};
  --step-header-selected-background: #{$mat-sys-surface-variant};
  --step-header-default-background: #{$mat-sys-surface};
  --toolbar-background: #{$mat-sys-surface};
  --datatable-background: #{$mat-sys-surface};
  --datatable-hover: #{$mat-sys-surface-variant};
}

@mixin color($theme-name, $theme) {
  // Extract M3 theme values using utility functions (same as color-variables)
  $main-primary: theme.get-main-color();
  $selection-background: theme.get-selection-background();
  $table-hover-color: theme.get-table-hover-color($main-primary);
  $background-color: theme.get-background-color();
  $hover-color: theme.get-hover-color();
  $panel-color: theme.get-panel-color();

  // Get custom semantic colors from M3 custom colors map
  $warn-color: theme.get-custom-color(warn-color);
  $error-color: theme.get-custom-color(error-color);
  $info-color: theme.get-custom-color(info-color);
  $success-color: theme.get-custom-color(success-color);

  // Panel colors from defaults
  $panel-background-color: theme.map-get-or-default(theme.$m3-custom-colors, panel-background-color);
  $panel-border-color: theme.map-get-or-default(theme.$m3-custom-colors, panel-border-color);
  $panel-select-background: theme.map-get-or-default(theme.$m3-custom-colors, panel-select-background);

  // This mixin now only contains non-variable color styles

  @if variable-exists(table-hover-color) {
    .clickable-table-row:hover,
    .mat-row-link:hover {
      background-color: $table-hover-color;
    }
  } @else {
    @warn 'variable $table-hover-color in theme #{$theme-name} is not defined';
  }

  @if variable-exists(warn-color) {
    .mat-mdc-form-field-required-marker {
      color: $warn-color;
    }

    .mat-chip.mat-standard-chip.mat-warn {
      color: $warn-color;
      border: 1px solid $warn-color;
    }
  } @else {
    @warn 'variable $warn-color in theme #{$theme-name} is not defined';
  }

  @if variable-exists(main-primary) {
    .mat-mdc-outlined-button {
      border-color: $main-primary !important;
    }
    .mat-chip-selected {
      border: 1px solid $main-primary !important;
      color: $main-primary !important;
    }
    .mat-stroked-button {
      border-color: $main-primary !important;
    }
    .selected-drag-list {
      border-color: $main-primary !important;
    }
    .active-column-definition {
      color: $main-primary !important;
    }
  } @else {
    @warn 'variable $main-primary  in theme #{$theme-name} is not defined';
  }

  .mat-chip-selected {
    background-color: var(--mat-sys-surface) !important;
  }
}

@mixin typography($theme-name, $theme) {
  // M3 typography is handled by mat.typography-hierarchy()
  // Typography is applied via global rules outside this mixin
}

@mixin flowbar-theme($theme) {
  // Flowbar component styles (replacing ::ng-deep violations)
  mad-flowbar {
    .mat-horizontal-stepper-header {
      padding: 0;
      height: auto;
    }

    .mat-step-header[aria-labelledby='disabled'] {
      pointer-events: none !important;
      cursor: not-allowed;
    }

    .mat-horizontal-content-container {
      padding: 0 0 10px 0;
    }

    .mat-stepper-horizontal-line {
      margin: 0 5px;
      border-top-width: 4px;
    }
  }
}

@mixin toolbar-theme($theme) {
  // Toolbar component styles (replacing ::ng-deep violations)
  .mad-toolbar .mat-badge-content {
    bottom: -7px;
    right: -7px;
  }
}

@mixin readonly-theme($theme) {
  // Readonly form field tooltip styles (replacing ::ng-deep violations)
  .custom-tooltip {
    font-size: 14px !important;
    word-break: break-all !important;
    white-space: normal !important;
  }
}

@mixin theme($theme-name, $theme) {
  // M3 themes include both color and typography
  // This mixin is called from :root for CSS variables
  @include color-variables($theme-name, $theme);
}

@mixin theme-styles($theme-name, $theme) {
  // Apply color-specific styles (not variables)
  @include color($theme-name, $theme);

  // Apply typography customizations
  @include typography($theme-name, $theme);

  // Apply component-specific theme mixins
  @include flowbar-theme($theme);
  @include toolbar-theme($theme);
  @include readonly-theme($theme);
}

// Global font-family MUST be outside mixin to be included in compiled CSS
html {
  font-family: Roboto, sans-serif;
}

body {
  margin: 0;
  font-family: Roboto, sans-serif;
}

a {
  color: inherit;
  text-decoration: inherit;
}

.spacer {
  flex: 1 1 auto;
}

table {
  width: 100%;
}

app-root {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.mat-mdc-input-element:disabled {
  cursor: auto;
  color: var(--mat-sys-on-surface);
}

.mat-mdc-select-disabled .mat-select-value {
  color: var(--mat-sys-on-surface);
}

.mat-mdc-form-field .mat-mdc-select.mat-select-disabled .mat-select-arrow {
  color: var(--mat-sys-surface);
}

.mat-mdc-checkbox-disabled .mat-checkbox-label {
  color: var(--mat-sys-on-surface);
}

.clickable-table-row:hover,
.mat-row-link:hover {
  cursor: pointer;
}

.button-panel {
  padding-top: 16px;
  padding-bottom: 8px;
  padding-right: 16px;
}

mad-primary-button {
  margin-right: 8px;
}

mad-outline-button {
  margin-right: 8px;
}

mad-link-button {
  margin-right: 8px;
}

mad-danger-button {
  margin-right: 8px;
}

.simple-edit-section {
  display: flex;
  flex-direction: column;
}

.simple-edit-section > * {
  width: 100%;
  max-width: 640px;
}

.tiny-table-section {
  display: flex;
  flex-direction: column;
}

.table-condensed > .mat-mdc-row {
  min-height: 36px;
}

.small-input {
  max-width: 90px !important;
}

.tiny-input {
  max-width: 60px !important;
}

.main-content {
  padding: 73px 16px 16px;
}

.mat-mdc-tab-header {
  margin: -16px -16px 16px;
}

.mat-mdc-row {
  position: relative;
}

.mat-row-link {
  position: absolute;
  width: 100%;
  height: 100%;
  left: 0;
  top: 0;
}

.mat-mdc-button,
.mat-mdc-unelevated-button,
.mat-mdc-raised-button,
.mat-mdc-outlined-button,
.mat-mdc-icon-button {
  text-transform: uppercase !important;
}

.toolbar-title {
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.mat-mdc-select-disabled {
  color: rgba(0, 0, 0, 0.38);  // Material Design spec for disabled state
}

.sticky-paginator {
  background-color: var(--mat-sys-surface);
  position: fixed;
  padding-right: 16px;
  bottom: 0;
  right: 0;
  left: 0;
  z-index: 5;
  text-align: right;
}

.with-sticky-paginator {
  padding-bottom: 64px;
}

.criteria-panel {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: flex-start;
}

.criteria-panel > * {
  padding-right: 16px;
}

.mat-chip.mat-standard-chip {
  background-color: var(--mat-sys-surface);
  color: var(--mat-sys-on-surface);
  border: 1px solid var(--mat-sys-outline);
}

.mat-chip.mat-standard-chip.mat-warn {
  background-color: var(--mat-sys-surface);
}

.mat-mdc-tab-group {
  max-width: 100%;
}

.large-icon {
  font-size: xx-large;
}

.transparent .mat-mdc-dialog-container {
  box-shadow: none;
  background: rgba(0, 0, 0, 0);
}

/*
* This class can be used to fix mat-tabs at the top of a page
*/
.fixedtabs > .mat-mdc-tab-header {
  z-index: 10;
  width: 100vw;
  position: fixed;
  background-color: var(--mat-sys-surface);
}

.mat-mdc-dialog-actions {
  justify-content: flex-end;
}

.mat-md-card-header-text {
  margin: 0 !important;
}

mat-icon.mat-icon.narrow-icon {
  margin-right: 0;
  margin-left: 0;
}

button.mat-mdc-menu-item {
  min-height: 38px;
}

.mat-toolbar {
  background-color: var(--panel-select-background);

  .mat-mdc-button {
    min-width: 0;
    padding: 0;
    margin: 0 5px;
  }
}

.drop-down {
  mat-icon.mat-icon.notranslate {
    padding: 0;
    margin: 0;
  }

  .mat-mdc-outlined-button:not(:disabled) {
    color: var(--mat-button-outlined-label-text-color, inherit);
    border-color: var(--mat-button-outlined-, inherit);
  }

  &::after {
    content: '\02C7';
    font-size: 2em !important;
    padding-top: 15px;
    padding-left: 3px;
  }
}

// full page
.top-nav-bar {
  top: 0;
  left: 0;
  right: 0;
  z-index: 2;
}

//maybe we have different navs for desktop, mobile,...
.top-main-nav {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  background-color: var(--mat-sys-surface);

  > .mat-mdc-button {
    &:last-child {
      margin-left: auto;
    }
  }
}

.flex-spacer {
  flex-grow: 1;
}

.logo {
  display: flex;
  height: 26px;
  margin-right: 20px;
}

.logo a {
  display: flex;
  align-items: center;
  gap: 5px;
  color: var(--main-primary);
}

@mixin ellipsis-text-overflow {
  text-overflow: ellipsis;
  overflow: hidden;
  white-space: nowrap;
}

.ellipsis-text-overflow {
  @include ellipsis-text-overflow;
}

@media print {
  .no-print,
  .no-print * {
    display: none !important;
    width: 0 !important;
    height: 0 !important;
  }

  mat-paginator {
    display: none !important;
    height: 0 !important;
  }

  mat-sidenav-content {
    margin: 0 !important;
  }

  .mat-mdc-raised-button,
  .mat-mdc-outlined-button,
  .button-panel {
    display: none !important;
  }

  mad-primary-button,
  mad-outline-button,
  mad-danger-button,
  mad-link-button,
  mad-icon-button {
    display: none !important;
  }

  .criteria-panel {
    display: none !important;
    height: 0 !important;
  }

  async-autocomplete mat-icon {
    display: none !important;
  }
  .mat-mdc-tab-label:not(.mat-tab-label-active) {
    display: none !important;
  }
}

.mad-read-only {
  mat-label {
    color: var(--mat-sys-on-surface);
  }
  .content {
    color: var(--mat-sys-on-surface) !important;
  }
  .mdc-notched-outline__leading,
  .mdc-notched-outline__notch,
  .mdc-notched-outline__trailing {
    border: none !important;
  }
}

// needed for the padding fix when subscriptSizing: 'dynamic'
mat-form-field .mat-mdc-form-field {
  &-subscript-wrapper {
    margin-bottom: 1.25em;
  }
}

// the label of the outline input is set into the padding of the form-field-component
.mat-form-field-appearance-outline {
  margin-top: 8px;
}

.pointer {
  cursor: pointer;
}

.quick-list-row {
  display: flex;
  flex-direction: row;
  mad-icon-button {
    margin-top: 8px;
  }
}
